# Data Model: Summary Rank Column and Mode-Specific Ordering Rules

## Entities

### 1) SummaryRankedRow
- **Purpose**: Canonical summary row used by UI with deterministic rank and order.
- **Fields**:
  - `rank`: displayed rank integer
  - `playerId`: stable player identity
  - `displayName`: player label
  - `cells`: per-column values (`R1..Rn`, `Total`)
  - `sortKey`: deterministic ordering key generated by mode rule
- **Validation rules**:
  - Rank must be present for progress and final rows.
  - Rows must be emitted in deterministic display order.

### 2) ModeOrderingRule
- **Purpose**: Rule set defining row order and rank generation for each mode.
- **Fields**:
  - `mode`: `Mexicano` | `Americano` | `BeatTheBox`
  - `progressRule`: ranking behavior during in-progress summary
  - `finalRule`: ranking behavior during final summary
  - `tieRule`: tie policy where applicable
- **Validation rules**:
  - Mexicano final tie rule uses competition ranking.
  - Americano final intra-pair order is alphabetical by display name.
  - BeatTheBox grouping follows global carry-over score progression.

### 3) AmericanoCourtOutcomeSlot
- **Purpose**: Rank slot information generated from final-round court outcomes.
- **Fields**:
  - `courtNumber`: final-round court identifier
  - `outcomeType`: `winner` | `loser`
  - `playerIds`: two players for slot group
  - `displayOrder`: alphabetical display-name order
  - `rankStart`: first rank number assigned to slot group
- **Validation rules**:
  - Courts processed highest to lowest.
  - Winners slots precede losers slots per court.

### 4) BeatTheBoxCourtGroup
- **Purpose**: Grouping bucket used to order BeatTheBox final rows.
- **Fields**:
  - `groupPriority`: higher-priority groups displayed first
  - `playerIds`: players in the group
  - `groupTotals`: total points map for players
- **Validation rules**:
  - Group priority derives from global carry-over score progression.
  - Inside a group, players sort by total descending with deterministic tie order.

### 5) SummaryOrderingMetadata
- **Purpose**: API payload extension exposing deterministic ordering/rank data.
- **Fields**:
  - `rankedRows`: ordered row list with explicit ranks
  - `orderingMode`: summary ordering mode identifier
  - `orderingVersion`: metadata version for contract stability
- **Validation rules**:
  - Metadata must be sufficient for frontend rendering without heuristic fallback.
  - Backward compatibility fields remain available during transition.

## Relationships

- `ModeOrderingRule` governs generation of `SummaryRankedRow`.
- `AmericanoCourtOutcomeSlot` contributes ordered segments to Americano `SummaryRankedRow` output.
- `BeatTheBoxCourtGroup` contributes grouped ordering for BeatTheBox `SummaryRankedRow` output.
- `SummaryOrderingMetadata` carries final ordered rows and rank values to frontend.

## State Transitions

### Summary ranking lifecycle
1. `summary-input-collected` -> read rounds/matches/standings and mode context
2. `mode-rule-selected` -> choose progress/final ordering rule by mode
3. `rank-order-computed` -> create deterministic ordered rows with explicit ranks
4. `summary-response-emitted` -> include rank/order metadata for frontend rendering

### Progress vs final mode behavior
1. `progress` -> rank by current accumulated score descending (all modes)
2. `final` -> apply mode-specific final ordering rules
